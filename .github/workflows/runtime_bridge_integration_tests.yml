name: runtime bridge integration tests

on:
  push:
jobs:
  ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - name: "List all simulators"
        run: "xcrun xctrace list devices"
      - name: "Start Simulator"
        # the command "xcrun simctl boot" expects a device identifier
        # the assignment of the UDID variable consists of retrieving the ID of the simulator
        # by extracting it from the command "xcrun xctrace list devices"
        run: |
          UDID=$(xcrun xctrace list devices | grep -m 1 "^iPhone" | awk '{gsub(/[()]/,""); print $NF}')
          echo $UDID
          xcrun simctl boot "${UDID:?No Simulator with this name found}"
      - name: Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Install Dependencies
        run: |
          dart pub global activate melos
          melos bootstrap
      - name: Run integration tests
        run: cd packages/enmeshed_runtime_bridge && flutter test integration_test/suite_test.dart --dart-define=connector_baseURL=${{secrets.TESTCONNECTOR_BASEURL}} --dart-define=connector_apiKey=${{secrets.TESTCONNECTOR_APIKEY}}
  android:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Install Dependencies
        run: |
          dart pub global activate melos
          melos bootstrap
      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          project_id: enmeshed
          credentials_json: ${{secrets.ENMESHED_FIREBASE_SERVICEACCOUNT_JSON}}
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: "oracle"
          java-version: 17
          cache: "gradle"
      - name: build android app
        env:
          DART_DEFINES: ${{secrets.DART_DEFINES}}
        working-directory: packages/enmeshed_runtime_bridge/android
        run: |
          # flutter build generates files in android/ for building the app
          flutter build apk `pwd`/../integration_test/suite_test.dart --debug
          ./gradlew app:assembleAndroidTest
          ./gradlew app:assembleDebug -Ptarget=`pwd`/../integration_test/suite_test.dart -Pdart-defines=$DART_DEFINES
      - name: execute tests on firebase
        working-directory: packages/enmeshed_runtime_bridge
        run: |
          gcloud firebase test android run --type instrumentation \
            --app build/app/outputs/apk/debug/app-debug.apk \
            --device model=Pixel3 \
            --test build/app/outputs/apk/androidTest/debug/app-debug-androidTest.apk\
            --timeout 30m
